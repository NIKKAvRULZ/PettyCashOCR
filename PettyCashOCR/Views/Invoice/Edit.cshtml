@model PettyCashOCR.Models.PettyCashVoucher

<h2>Edit Petty Cash Voucher</h2>

<!-- Display Voucher Info -->
<div>
    <h3>🧾 Extracted Petty Cash Voucher Data:</h3>
    <table class="voucher-table">
        <thead>
            <tr>
                <th>Voucher No</th>
                <th>Claimed By</th>
                <th>Staff No</th>
                <th>Department</th>
                <th>Cost Center</th>
                <th>Station</th>
                <th>Date</th>
                <th>Approved By</th>
                <th>Received Cash</th>
                <th>Amount In Words</th>
                <th>Total Amount</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>@Model.VoucherNo</td>
                <td>@Model.PaidTo</td>
                <td>@Model.StaffNo</td>
                <td>@Model.Department</td>
                <td>@Model.CostCenter</td>
                <td>@Model.Station</td>
                <td>@Model.Date</td>
                <td>@Model.ApprovedBy</td>
                <td>@Model.ReceivedCash</td>
                <td>@Model.AmountInWords</td>
                <td>@Model.TotalAmount.ToString("N2")</td>
            </tr>
        </tbody>
    </table>
</div>

<h3>✏️ Edit Voucher</h3>
<form asp-action="Save" asp-controller="Invoice" method="post" id="voucherForm">
    @* Hidden ID if needed *@
    <input type="hidden" name="Id" value="@Model.Id" />

    <div><label>Voucher No</label><input name="VoucherNo" value="@Model.VoucherNo" /></div>
    <div><label>Claimed By</label><input name="PaidTo" value="@Model.PaidTo" /></div>
    <div><label>Staff No</label><input name="StaffNo" value="@Model.StaffNo" /></div>
    <div><label>Department</label><input name="Department" value="@Model.Department" /></div>
    <div><label>Cost Center</label><input name="CostCenter" value="@Model.CostCenter" /></div>
    <div><label>Station</label><input name="Station" value="@Model.Station" /></div>
    <div><label>Date</label><input name="Date" value="@Model.Date" /></div>
    <div><label>Approved By</label><input name="ApprovedBy" value="@Model.ApprovedBy" /></div>
    <div><label>Received Cash</label><input name="ReceivedCash" value="@Model.ReceivedCash" /></div>
    <div><label>Amount In Words</label><input name="AmountInWords" value="@Model.AmountInWords" /></div>
    <div><label>Total Amount</label><input type="number" step="0.01" name="TotalAmount" value="@Model.TotalAmount" /></div>

    <h4>📋 Line Items</h4>
    <table id="line-items-table" class="line-items-table">
        <thead>
            <tr><th>Description</th><th>Amount</th><th>Action</th></tr>
        </thead>
        <tbody>
            @for (int i = 0; i < Model.LineItems?.Count; i++)
            {
                <tr>
                    <td><input name="LineItems[@i].Details" value="@Model.LineItems[i].Details" /></td>
                    <td><input type="number" step="0.01" name="LineItems[@i].Amount" value="@Model.LineItems[i].Amount" /></td>
                    <td><button type="button" onclick="removeLineItem(this)">Remove</button></td>
                </tr>
            }
        </tbody>
    </table>
    <button type="button" onclick="addLineItem()">Add Line Item</button>

    <h4>📋 Budgetery Details</h4>
    <table id="line-items-table" class="line-items-table">
        <thead>
            <tr><th>Account</th>
                <th>CC</th>
                <th>Budget</th>
                <th>Utilized</th>
                <th>Variance</th>
                <th>This Payment</th>
            </tr>
        </thead>
        <tbody>
            @for (int i = 0; i < Model.BudgeteryDetails?.Count; i++)
            {
                <tr>
                    <td><input name="BudgeteryDetails[@i].Account" value="@Model.BudgeteryDetails[i].Account" /></td>
                    <td><input name="BudgeteryDetails[@i].CC" value="@Model.BudgeteryDetails[i].CC" /></td>
                    <td><input type="number" step="0.01" name="BudgeteryDetails[@i].Budget" value="@Model.BudgeteryDetails[i].Budget" /></td>
                    <td><input type="number" step="0.01" name="BudgeteryDetails[@i].Utilised" value="@Model.BudgeteryDetails[i].Utilised" /></td>
                    <td><input type="number" step="0.01" name="BudgeteryDetails[@i].Variance" value="@Model.BudgeteryDetails[i].Variance" /></td>
                    <td><input type="number" step="0.01" name="BudgeteryDetails[@i].ThisPayment" value="@Model.BudgeteryDetails[i].ThisPayment" /></td>
                    <td><button type="button" onclick="">Remove</button></td>
                </tr>
            }
        </tbody>
    </table>


    <h4>📋 Accounting Allocation </h4>
    <table id="line-items-table" class="line-items-table">
        <thead>
            <tr>
                <th>Account</th>
                <th>CC</th>
                <th>FLT No</th>
                <th>ACRFT</th>
                <th>PROJ</th>
                <th>Amount</th>
                <th>Cross Ref</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            @for (int i = 0; i < Model.AccountingAllocations?.Count; i++)
            {
                <tr>
                    <td><input name="AccountingAllocations[@i].Account" value="@Model.AccountingAllocations[i].Account" /></td>
                    <td><input name="AccountingAllocations[@i].CC" value="@Model.AccountingAllocations[i].CC" /></td>
                    <td><input type="number" step="0.01" name="AccountingAllocations[@i].FLTNO" value="@Model.AccountingAllocations[i].FLTNO" /></td>
                    <td><input type="number" step="0.01" name="AccountingAllocations[@i].ACRFT" value="@Model.AccountingAllocations[i].ACRFT" /></td>
                    <td><input type="number" step="0.01" name="AccountingAllocations[@i].PROJ" value="@Model.AccountingAllocations[i].PROJ" /></td>
                    <td><input type="number" step="0.01" name="AccountingAllocations[@i].Amount" value="@Model.AccountingAllocations[i].Amount" /></td>
                    <td><input type="number" step="0.01" name="AccountingAllocations[@i].CrossReference" value="@Model.AccountingAllocations[i].CrossReference" /></td>
                    <td><input name="AccountingAllocations[@i].Description" value="@Model.AccountingAllocations[i].Description" /></td>
                    <td><button type="button" onclick="">Remove</button></td>
                </tr>
            }
        </tbody>
    </table>

    <br />
    <button type="submit" id="saveVoucherBtn">Save Voucher</button>
</form>

<style>
    .voucher-table, .line-items-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }

        .voucher-table th, .voucher-table td, .line-items-table th, .line-items-table td {
            border: 1px solid #ccc;
            padding: 8px;
        }

        .line-items-table input {
            width: 100%;
        }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    let lineItemIndex = @Model.LineItems?.Count ?? 0;

    function addLineItem() {
        const tbody = $("#line-items-table tbody");
        const rowHtml = `
            <tr>
                <td><input name="LineItems[${lineItemIndex}].Details" /></td>
                <td><input type="number" step="0.01" name="LineItems[${lineItemIndex}].Amount" /></td>
                <td><button type="button" onclick="removeLineItem(this)">Remove</button></td>
            </tr>`;
        tbody.append(rowHtml);
        lineItemIndex++;
    }

    function removeLineItem(button) {
        $(button).closest("tr").remove();
        // Optional: Renumbering can be added here if needed
    }

    $("#voucherForm").submit(function (e) {
        e.preventDefault();
        const formData = $(this).serialize();
        $.ajax({
            url: '/Invoice/Save',
            method: 'POST',
            data: formData,
            success: function () {
                alert('Voucher saved successfully!');
                window.location.href = '/Invoice/List';
            },
            error: function (xhr) {
                alert('Error saving voucher: ' + xhr.responseText);
            }
        });
    });
</script>
